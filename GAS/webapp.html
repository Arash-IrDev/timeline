<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project Timeline - Web App</title>

  <?!= include('styles'); ?>

  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0;
      overflow: hidden;
    }
    #app { 
      width: 100%; 
      height: 100vh; 
      position: fixed;
      top: 0;
      left: 0;
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
    }
    
    /* Web App specific styles */
    .webapp-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: #1f1f1f;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      z-index: 1000;
      font-size: 14px;
    }
    
    .webapp-title {
      font-weight: 600;
    }
    
    .webapp-controls {
      display: flex;
      gap: 10px;
    }
    
    .webapp-btn {
      background: #333;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .webapp-btn:hover {
      background: #555;
    }
    
    .webapp-content {
      margin-top: 40px;
      height: calc(100vh - 40px);
    }
  </style>
</head>
<body>
  <div class="webapp-header">
    <div class="webapp-title">ðŸ“Š Project Timeline</div>
    <div class="webapp-controls">
      <button class="webapp-btn" onclick="refreshData()">ðŸ”„ Refresh</button>
      <button class="webapp-btn" onclick="toggleFullscreen()">â›¶ Fullscreen</button>
    </div>
  </div>
  
  <div class="webapp-content">
    <div id="app"></div>
  </div>

  <script>
    // ------------------------------------------------------------
    // Web App specific functionality
    // ------------------------------------------------------------
    let REAL_DATA = '';
    let refreshInterval = null;

    // Some bundles access process.env
    window.process = { env: { NODE_ENV: 'production' } };

    // Minimal logger
    function dbg(stage, payload) {
      try {
        console.log(`[Timeline WebApp][${stage}]`, payload);
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          const msg = (typeof payload === 'string') ? payload : JSON.stringify(payload);
          google.script.run
            .withFailureHandler(function(){})
            .logClient(stage, String(msg).slice(0, 5000));
        }
      } catch (_) {}
    }

    window.onerror = function (message, source, line, column, error) {
      dbg('window.onerror', {
        message: String(message),
        source: String(source || ''),
        line: line || 0,
        column: column || 0,
        stack: error && error.stack ? String(error.stack).slice(0, 4000) : ''
      });
    };

    // ------------------------------------------------------------
    // Initialize state
    // ------------------------------------------------------------
    window.raw = REAL_DATA;
    window.__markwhen_initial_state = window.__markwhen_initial_state || {};

    // ------------------------------------------------------------
    // Web App specific functions
    // ------------------------------------------------------------
    function refreshData() {
      dbg('webapp_refresh', 'Manual refresh triggered');
      fetchRealData();
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          dbg('fullscreen_error', err);
        });
      } else {
        document.exitFullscreen().catch(err => {
          dbg('fullscreen_error', err);
        });
      }
    }

    // Auto-refresh every 30 seconds
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => {
        dbg('webapp_auto_refresh', 'Auto-refreshing data');
        fetchRealData();
      }, 30000);
    }

    // ------------------------------------------------------------
    // Intercept fetches for sample text
    // ------------------------------------------------------------
    (function interceptFetchForSample() {
      if (!('fetch' in window)) return;
      const realFetch = window.fetch.bind(window);

      window.fetch = async function(input, init) {
        let url = '';
        try { url = (typeof input === 'string') ? input : (input && input.url) || ''; } catch (_){}

        if (url.endsWith('/sample.mw') || url.includes('meridiem.markwhen.com') || url.endsWith('.mw')) {
          dbg('fetch_intercept', url);
          return new Response(REAL_DATA, {
            status: 200,
            headers: { 'Content-Type': 'text/plain; charset=utf-8' }
          });
        }
        return realFetch(input, init);
      };
    })();

    function hydrateAndRenderTimeline(markwhenText) {
      REAL_DATA = markwhenText || '';
      dbg('data_fetch_ok', REAL_DATA.slice(0, 120));

      window.raw = REAL_DATA;
      window.__markwhen_initial_state = window.__markwhen_initial_state || {};
      window.__markwhen_initial_state.rawText = REAL_DATA;

      renderTimeline();
    }

    // ------------------------------------------------------------
    // Fetch real data from Google Apps Script
    // ------------------------------------------------------------
    function fetchRealData() {
      if (!(google && google.script && google.script.run)) {
        dbg('data_fetch_fail', 'google.script.run not available');
        return;
      }

      google.script.run
        .withSuccessHandler(function (markwhenText) {
          hydrateAndRenderTimeline(markwhenText);
        })
        .withFailureHandler(function (err) {
          dbg('data_fetch_fail', String(err));
          REAL_DATA = '';
          renderTimeline();
        })
        .getMarkwhenRawText();
    }

    // ------------------------------------------------------------
    // Bundle loading and execution
    // ------------------------------------------------------------
    function bootBundle(onReady) {
      if (!(google && google.script && google.script.run)) {
        dbg('bundle_fetch_fail', 'google.script.run not available');
        return;
      }

      google.script.run
        .withSuccessHandler(function (b64js) {
          try {
            let js = atob(b64js || '');
            dbg('bundle_fetch_ok', { length: js.length, head: js.slice(0, 120) });

            // Fix known broken regexes from build
            const litRegex  = /\/\^\?\\s\*\//g;
            const ctorRegex = /new RegExp\(['"]\^\?\\s\*['"]\)/g;
            const litCount  = (js.match(litRegex)  || []).length;
            const ctorCount = (js.match(ctorRegex) || []).length;
            js = js.replace(litRegex, '/^\\s*/')
                   .replace(ctorRegex, "new RegExp('^\\s*')");
            dbg('bundle_patch_counts', { literal: litCount, ctor: ctorCount });

            // Strip ES module syntax
            if (/\bexport\b|\bimport\b/.test(js)) {
              js = js.replace(/^\s*import[\s\S]*?;[ \t]*$/gm, '');
              js = js.replace(/\bexport\s+default\s+(async\s+)?function\s+([A-Za-z$_]\w*)/g,
                              '$1function $2');
              js = js.replace(/\bexport\s+default\s+class\s+([A-Za-z$_]\w*)/g,
                              'class $1');
              js = js.replace(/\bexport\s+default\s+([^\n;]+)/g,
                              'window.__bundle_default__ = ($1)');
              js = js.replace(/\bexport\s+(const|let|var)\s+/g, '$1 ');
              js = js.replace(/\bexport\s+(async\s+)?function\s+/g, '$1function ');
              js = js.replace(/\bexport\s+class\s+/g, 'class ');
              js = js.replace(/\bexport\s*\{[^}]*\};?/g, '');
              js = js.replace(/\bexport\s*\*\s*from\s*['"][^'"]+['"];?/g, '');

              if (!/window\.__bundle_default__\s*=/.test(js)) {
                const m = js.match(/\b(class|function)\s+([A-Za-z$_]\w*)/);
                if (m && m[2]) {
                  js += `\n;try{window.__bundle_default__=${m[2]};}catch(_){}`;
                }
              }
            }

            // Syntax check
            try { new Function(js); } catch (syntaxErr) {
              dbg('bundle_syntax_error_preview', js.slice(0, 500));
              throw syntaxErr;
            }

            // Provide shims
            try {
              window.globalThis = window.globalThis || window;
              window.self = window.self || window;
              window.global = window.global || window;
              window.process = window.process || { env: { NODE_ENV: 'production' } };
              if (!('queueMicrotask' in window)) window.queueMicrotask = (cb) => Promise.resolve().then(cb);
              if (!('requestAnimationFrame' in window)) window.requestAnimationFrame = (cb) => setTimeout(cb, 16);
              if (!('cancelAnimationFrame' in window)) window.cancelAnimationFrame = (id) => clearTimeout(id);
              if (!('requestIdleCallback' in window)) window.requestIdleCallback = (cb) => setTimeout(() => cb({ didTimeout:false, timeRemaining: () => 1 }), 50);
              if (!('cancelIdleCallback' in window)) window.cancelIdleCallback = (id) => clearTimeout(id);
              if (!('performance' in window)) window.performance = { now: () => Date.now() };
              if (!('structuredClone' in window)) window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));
              if (!('ResizeObserver' in window)) window.ResizeObserver = function(){ this.observe=()=>{}; this.unobserve=()=>{}; this.disconnect=()=>{}; };
              if (!('IntersectionObserver' in window)) window.IntersectionObserver = function(){ this.observe=()=>{}; this.unobserve=()=>{}; this.disconnect=()=>{}; };
              if (!('MutationObserver' in window)) window.MutationObserver = function(){ this.observe=()=>{}; this.disconnect=()=>{}; };
              if (!('matchMedia' in window)) {
                window.matchMedia = function(){
                  return { matches:false, media:'', onchange:null, addListener:()=>{}, removeListener:()=>{}, addEventListener:()=>{}, removeEventListener:()=>{}, dispatchEvent:()=>false };
                };
              }
              if (!('CSS' in window)) window.CSS = { supports: () => false };
              if (!('crypto' in window) || !window.crypto.getRandomValues) {
                window.crypto = window.crypto || {};
                window.crypto.getRandomValues = function(arr){
                  for (let i=0;i<arr.length;i++) arr[i] = Math.floor(Math.random()*256);
                  return arr;
                };
              }
            } catch(_){ }

            // Execute bundle
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.text = js;
            document.head.appendChild(script);
            dbg('bundle_exec_ok', true);

            if (typeof onReady === 'function') {
              onReady();
            }

          } catch (e) {
            dbg('bundle_exec_fail', String(e && e.stack || e));
          }
        })
        .withFailureHandler(function (err) {
          dbg('bundle_fetch_fail', String(err));
        })
        .getBundleBase64();
    }

    function renderTimeline() {
      if (window.__timeline_bundle_loaded) {
        dbg('bundle_reuse', 'Rendering with existing bundle');
        mountTimeline();
        return;
      }

      bootBundle(function () {
        window.__timeline_bundle_loaded = true;
        mountTimeline();
      });
    }

    function mountTimeline() {
      try {
        if (typeof window.__timeline_updateData === 'function') {
          window.__timeline_updateData({ rawText: REAL_DATA });
        }
        if (typeof window.__bundle_default__ === 'function' && !window.__timeline_vm_mounted) {
          window.__bundle_default__({ target: '#app' });
          window.__timeline_vm_mounted = true;
        }
      } catch (e) {
        dbg('timeline_mount_fail', String(e && e.stack || e));
      }
    }

    // ------------------------------------------------------------
    // Initialize Web App
    // ------------------------------------------------------------
    function initWebApp() {
      dbg('webapp_init', 'Initializing Web App');
      fetchRealData();
      startAutoRefresh();
    }

    // Start when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWebApp);
    } else {
      initWebApp();
    }
  </script>
</body>
</html>
